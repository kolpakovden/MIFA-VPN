#!/bin/bash

# =============================================
# СКРИПТ МОНИТОРИНГА ПОДКЛЮЧЕНИЙ XRAY
# =============================================
# Описание:
#   Скрипт анализирует лог Xray, находит новые IP-адреса
#   за последние 5 минут и отправляет уведомление в Telegram.
#
# Зависимости:
#   - curl (для отправки уведомлений)
#   - доступ на чтение /var/log/xray/access.log
#
# Настройка:
#   1. Укажите BOT_TOKEN и CHAT_ID
#   2. Добавьте в cron для запуска каждую минуту
# =============================================

# ---------------------------
# 1. НАСТРОЙКИ (ЗАПОЛНИТЬ ОБЯЗАТЕЛЬНО)
# ---------------------------

# Токен Telegram-бота (получить у @BotFather)
BOT_TOKEN="вставьте_сюда_токен_бота"

# Ваш Chat ID (узнать у @userinfobot)
CHAT_ID="вставьте_сюда_chat_id"

# ---------------------------
# 2. КОНФИГУРАЦИЯ (можно менять при необходимости)
# ---------------------------

# Путь к логу доступа Xray
LOG_FILE="/var/log/xray/access.log"

# Файл для хранения IP, которые уже были обработаны
OLD_FILE="/tmp/online_ips.txt"

# Временный файл для текущих IP
CURRENT_FILE="/tmp/current_ips.txt"

# ---------------------------
# 3. ПОЛУЧЕНИЕ IP ИЗ ЛОГА
# ---------------------------

# Определяем дату 5 минут назад (для фильтрации свежих записей)
FIVE_MIN_AGO=$(date --date='5 minutes ago' '+%Y-%m-%d %H:%M')

# Извлекаем IP из лога:
# - отбираем строки не старше 5 минут
# - ищем паттерн "from X.X.X.X"
# - вырезаем IP, сортируем, убираем дубликаты
awk -v date="$FIVE_MIN_AGO" '$0 > date {print}' "$LOG_FILE" | \
grep -oE 'from [0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' | \
awk '{print $2}' | sort -u > "$CURRENT_FILE"

# ---------------------------
# 4. ПЕРВЫЙ ЗАПУСК
# ---------------------------

# Если нет файла со старыми IP — создаём и выходим
if [ ! -f "$OLD_FILE" ]; then
    cp "$CURRENT_FILE" "$OLD_FILE"
    echo "Первый запуск. Создан файл $OLD_FILE"
    exit 0
fi

# ---------------------------
# 5. ПОИСК НОВЫХ IP
# ---------------------------

# Перебираем все IP из текущего списка
while read ip; do
    # Если IP нет в старом файле — значит он новый
    if ! grep -q "$ip" "$OLD_FILE"; then

        # ---------------------------
        # 6. ПОЛУЧЕНИЕ ГЕО-ДАННЫХ
        # ---------------------------

        # Запрашиваем информацию об IP через бесплатное API ip-api.com
        # (ограничение: 45 запросов в минуту)
        geo=$(curl -s "http://ip-api.com/json/${ip}?fields=country,regionName,city,isp")

        # Извлекаем поля из JSON-ответа
        country=$(echo "$geo" | grep -o '"country":"[^"]*"' | cut -d'"' -f4)
        region=$(echo "$geo" | grep -o '"regionName":"[^"]*"' | cut -d'"' -f4)
        city=$(echo "$geo" | grep -o '"city":"[^"]*"' | cut -d'"' -f4)
        isp=$(echo "$geo" | grep -o '"isp":"[^"]*"' | cut -d'"' -f4)

        # ---------------------------
        # 7. ФОРМИРОВАНИЕ СООБЩЕНИЯ
        # ---------------------------

        # Базовое сообщение
        msg="*Новое подключение к VPN!*%0A"
        msg="${msg} *IP:* \`${ip}\`%0A"

        # Добавляем поля, если они не пустые
        [ -n "$city" ] && msg="${msg}*Город:* ${city}%0A"
        [ -n "$region" ] && [ "$region" != "$city" ] && msg="${msg}*Регион:* ${region}%0A"
        [ -n "$country" ] && msg="${msg}*Страна:* ${country}%0A"
        [ -n "$isp" ] && msg="${msg}*Провайдер:* ${isp}%0A"

        # Добавляем время
        msg="${msg}*Время:* $(date '+%d.%m.%Y %H:%M:%S')"

        # ---------------------------
        # 8. ОТПРАВКА В TELEGRAM
        # ---------------------------

        # Отправляем сообщение через Telegram API
        curl -s "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
            --data "chat_id=$CHAT_ID" \
            --data "text=$msg" \
            --data "parse_mode=Markdown" > /dev/null

        # Небольшая задержка, чтобы не превысить лимиты API
        sleep 1
    fi
done < "$CURRENT_FILE"

# ---------------------------
# 9. ОБНОВЛЕНИЕ ФАЙЛА СО СТАРЫМИ IP
# ---------------------------

# Копируем текущий список в старый для следующего запуска
cp "$CURRENT_FILE" "$OLD_FILE"

# ---------------------------
# 10. ЗАВЕРШЕНИЕ
# ---------------------------
exit 0
