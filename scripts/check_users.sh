#!/bin/bash

# =============================================
# –°–ö–†–ò–ü–¢ –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ô XRAY
# =============================================
# –û–ø–∏—Å–∞–Ω–∏–µ:
#   –°–∫—Ä–∏–ø—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ª–æ–≥ Xray, –Ω–∞—Ö–æ–¥–∏—Ç –Ω–æ–≤—ã–µ IP-–∞–¥—Ä–µ—Å–∞
#   –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram.
#
# –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
#   - curl (–¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)
#   - –¥–æ—Å—Ç—É–ø –Ω–∞ —á—Ç–µ–Ω–∏–µ /var/log/xray/access.log
#
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞:
#   1. –£–∫–∞–∂–∏—Ç–µ BOT_TOKEN –∏ CHAT_ID
#   2. –î–æ–±–∞–≤—å—Ç–µ –≤ cron –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
# =============================================

# ---------------------------
# 1. –ù–ê–°–¢–†–û–ô–ö–ò (–ó–ê–ü–û–õ–ù–ò–¢–¨ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)
# ---------------------------

# –¢–æ–∫–µ–Ω Telegram-–±–æ—Ç–∞ (–ø–æ–ª—É—á–∏—Ç—å —É @BotFather)
BOT_TOKEN="–≤—Å—Ç–∞–≤—å—Ç–µ_—Å—é–¥–∞_—Ç–æ–∫–µ–Ω_–±–æ—Ç–∞"

# –í–∞—à Chat ID (—É–∑–Ω–∞—Ç—å —É @userinfobot)
CHAT_ID="–≤—Å—Ç–∞–≤—å—Ç–µ_—Å—é–¥–∞_chat_id"

# ---------------------------
# 2. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
# ---------------------------

# –ü—É—Ç—å –∫ –ª–æ–≥—É –¥–æ—Å—Ç—É–ø–∞ Xray
LOG_FILE="/var/log/xray/access.log"

# –§–∞–π–ª –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è IP, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –±—ã–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã
OLD_FILE="/tmp/online_ips.txt"

# –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è —Ç–µ–∫—É—â–∏—Ö IP
CURRENT_FILE="/tmp/current_ips.txt"

# ---------------------------
# 3. –ü–û–õ–£–ß–ï–ù–ò–ï IP –ò–ó –õ–û–ì–ê
# ---------------------------

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞—Ç—É 5 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥ (–¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–≤–µ–∂–∏—Ö –∑–∞–ø–∏—Å–µ–π)
FIVE_MIN_AGO=$(date --date='5 minutes ago' '+%Y-%m-%d %H:%M')

# –ò–∑–≤–ª–µ–∫–∞–µ–º IP –∏–∑ –ª–æ–≥–∞:
# - –æ—Ç–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –Ω–µ —Å—Ç–∞—Ä—à–µ 5 –º–∏–Ω—É—Ç
# - –∏—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω "from X.X.X.X"
# - –≤—ã—Ä–µ–∑–∞–µ–º IP, —Å–æ—Ä—Ç–∏—Ä—É–µ–º, —É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
awk -v date="$FIVE_MIN_AGO" '$0 > date {print}' "$LOG_FILE" | \
grep -oE 'from [0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' | \
awk '{print $2}' | sort -u > "$CURRENT_FILE"

# ---------------------------
# 4. –ü–ï–†–í–´–ô –ó–ê–ü–£–°–ö
# ---------------------------

# –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–∞–π–ª–∞ —Å–æ —Å—Ç–∞—Ä—ã–º–∏ IP ‚Äî —Å–æ–∑–¥–∞—ë–º –∏ –≤—ã—Ö–æ–¥–∏–º
if [ ! -f "$OLD_FILE" ]; then
    cp "$CURRENT_FILE" "$OLD_FILE"
    echo "–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫. –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª $OLD_FILE"
    exit 0
fi

# ---------------------------
# 5. –ü–û–ò–°–ö –ù–û–í–´–• IP
# ---------------------------

# –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ IP –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
while read ip; do
    # –ï—Å–ª–∏ IP –Ω–µ—Ç –≤ —Å—Ç–∞—Ä–æ–º —Ñ–∞–π–ª–µ ‚Äî –∑–Ω–∞—á–∏—Ç –æ–Ω –Ω–æ–≤—ã–π
    if ! grep -q "$ip" "$OLD_FILE"; then

        # ---------------------------
        # 6. –ü–û–õ–£–ß–ï–ù–ò–ï –ì–ï–û-–î–ê–ù–ù–´–•
        # ---------------------------

        # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± IP —á–µ—Ä–µ–∑ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–µ API ip-api.com
        # (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: 45 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É)
        geo=$(curl -s "http://ip-api.com/json/${ip}?fields=country,regionName,city,isp")

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ–ª—è –∏–∑ JSON-–æ—Ç–≤–µ—Ç–∞
        country=$(echo "$geo" | grep -o '"country":"[^"]*"' | cut -d'"' -f4)
        region=$(echo "$geo" | grep -o '"regionName":"[^"]*"' | cut -d'"' -f4)
        city=$(echo "$geo" | grep -o '"city":"[^"]*"' | cut -d'"' -f4)
        isp=$(echo "$geo" | grep -o '"isp":"[^"]*"' | cut -d'"' -f4)

        # ---------------------------
        # 7. –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø
        # ---------------------------

        # –ë–∞–∑–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        msg="üîî *–ù–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ VPN!*%0A"
        msg="${msg}üìç *IP:* \`${ip}\`%0A"

        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –ø—É—Å—Ç—ã–µ
        [ -n "$city" ] && msg="${msg}üèôÔ∏è *–ì–æ—Ä–æ–¥:* ${city}%0A"
        [ -n "$region" ] && [ "$region" != "$city" ] && msg="${msg}üåç *–†–µ–≥–∏–æ–Ω:* ${region}%0A"
        [ -n "$country" ] && msg="${msg}üåé *–°—Ç—Ä–∞–Ω–∞:* ${country}%0A"
        [ -n "$isp" ] && msg="${msg}üì° *–ü—Ä–æ–≤–∞–π–¥–µ—Ä:* ${isp}%0A"

        # –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è
        msg="${msg}üïí *–í—Ä–µ–º—è:* $(date '+%d.%m.%Y %H:%M:%S')"

        # ---------------------------
        # 8. –û–¢–ü–†–ê–í–ö–ê –í TELEGRAM
        # ---------------------------

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram API
        curl -s "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
            --data "chat_id=$CHAT_ID" \
            --data "text=$msg" \
            --data "parse_mode=Markdown" > /dev/null

        # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç—ã API
        sleep 1
    fi
done < "$CURRENT_FILE"

# ---------------------------
# 9. –û–ë–ù–û–í–õ–ï–ù–ò–ï –§–ê–ô–õ–ê –°–û –°–¢–ê–†–´–ú–ò IP
# ---------------------------

# –ö–æ–ø–∏—Ä—É–µ–º —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ –≤ —Å—Ç–∞—Ä—ã–π –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–ø—É—Å–∫–∞
cp "$CURRENT_FILE" "$OLD_FILE"

# ---------------------------
# 10. –ó–ê–í–ï–†–®–ï–ù–ò–ï
# ---------------------------
exit 0
